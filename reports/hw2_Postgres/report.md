# Тестирование производительности с индексом и без

* [урл апи для теста](http://localhost:8080/swagger-ui/index.html#/user/userSearchGet)
* генерация тестовых данных командой __gradle bootRun --args="--generate_users=1000"__
* [сценарий(jmeter) для создания нагрузки](search_dos.jmx)

## Методология тестировния

* при тестировании приложение, бд и создаваемая нагрузка находятся на 1 машине
* нагрузка создается при помощи приложения jmeter. [сценарий(jmeter) для создания нагрузки](search_dos.jmx)
    * Приложени отправляет запросы на поиск по имени и фамилии, подставляя в запрос рандомную 1 букву (худший вариант
      поиска)
* тестирование проводится в 3 этапа
    * в 1 поток
    * в 10 потоков
    * в 50 потоков
* после проведения пероприятий по оптимизации тесты повторяются
* после каждого замера приложение и бд перезапускаются

## Состояние бд на начало тестов

![статистика таблицы до начала работ](./db_stats_before.png "статистика таблицы до начала работ")
![индексы до начала работ](./db_index_before.png "индексы таблицы до начала работ")
![пример тестовых данных](./db_data_before.png "пример тестовых данных")

## Замер производительности при начальном состоянии

### в 1 поток

![](./graph_1_before.png)
![](./aggregate_1_before.png)

### в 10 потоков

![](./graph_10_before.png)
![](./aggregate_10_before.png)

### в 50 потоков

![](./graph_50_before.png)
![](./aggregate_50_before.png)

## Оптимизация работы БД

```postgresql
CREATE INDEX users_name_surname_idx ON public.users (lower("name") varchar_pattern_ops,lower(surname) varchar_pattern_ops);
```

опция varchar_pattern_ops нужна для оптимизации индекса под поиск по префиксу, с этой оптимизацией индекс будет
использован для поиска по 2-м полям, без нее индекс не используется.

![](./explain_after.png)

## Замер производительности после создания индексов

### в 1 поток

![](./graph_1_after.png)
![](./aggregate_1_after.png)

### в 10 потоков

![](./graph_10_after.png)
![](./aggregate_10_after.png)

### в 50 потоков

![](./graph_50_after.png)
![](./aggregate_50_after.png)

## Сравнение результатов

### 1 поток

![](./aggregate_1_before.png)
![](./aggregate_1_after.png)

### 50 потоков

![](./aggregate_50_before.png)
![](./aggregate_50_after.png)
